# План исправления проблемы с отправкой сообщений для YooKassa платежей

## Проблема
При создании платежа через YooKassa:
- ✅ Платеж создается в БД
- ❌ Сообщение с ссылкой на оплату НЕ отправляется пользователю

## Причина
**Неправильный порядок операций:**
1. Платеж создается в БД (`manager.create_payment()` → `payment_repo.create_payment()`)
2. Затем вызывается YooKassa API (`gateway.create_payment()`)
3. Если YooKassa API таймаутится/возвращает ошибку → исключение
4. Исключение перехватывается в `process_payment()`, но платеж уже в БД
5. Сообщение не отправляется, т.к. исключение произошло до отправки

**Доказательства из логов:**
- `[2025-12-08 20:17:41,838] INFO: Creating YooKassa payment for user 7559373710, amount=200`
- После этого нет строки "YooKassa payment created successfully"
- Платеж 136 был создан в БД, но у него нет `yookassa_payment_id` в metadata
- В логах видны таймауты: `Connection to api.yookassa.ru timed out`

## План исправления

### Вариант 1: Изменить порядок операций (РЕКОМЕНДУЕТСЯ)
**Идея:** Создавать платеж в БД только ПОСЛЕ успешного создания в YooKassa

**Шаги:**
1. В `YooKassaGateway.create_payment()`:
   - Сначала создать платеж в YooKassa API
   - Только после успешного ответа создать запись в БД
   - Вернуть `PaymentResult` с `pay_url`

2. В `PaymentManager.create_payment()`:
   - Для YooKassa: передать `payment_id=None` в `gateway.create_payment()`
   - Gateway сам создаст платеж в БД после успешного ответа YooKassa
   - Для других методов оставить текущую логику

3. Обновить `YooKassaGateway.create_payment()`:
   - Убрать требование `payment_id is not None`
   - Создать платеж в YooKassa
   - После успеха создать запись в БД через `payment_repo.create_payment()`
   - Вернуть `PaymentResult` с созданным `payment_id`

**Плюсы:**
- ✅ Платеж в БД создается только при успешном ответе YooKassa
- ✅ Нет "висящих" платежей в БД без `yookassa_payment_id`
- ✅ Сообщение всегда отправляется, т.к. платеж создается только при успехе

**Минусы:**
- ⚠️ Нужно изменить логику для YooKassa (но это правильно)

### Вариант 2: Откат транзакции при ошибке
**Идея:** Использовать транзакцию БД и откатывать при ошибке YooKassa

**Шаги:**
1. В `PaymentManager.create_payment()`:
   - Начать транзакцию БД
   - Создать платеж в БД
   - Вызвать `gateway.create_payment()`
   - Если исключение → откатить транзакцию
   - Если успех → закоммитить транзакцию

**Плюсы:**
- ✅ Сохраняет текущий порядок операций
- ✅ Платеж не остается в БД при ошибке

**Минусы:**
- ⚠️ Если YooKassa API медленный, транзакция БД будет долго открыта
- ⚠️ Может быть проблема с блокировками БД

### Вариант 3: Отправка сообщения в finally блоке
**Идея:** Всегда отправлять сообщение, даже при ошибке (с информацией об ошибке)

**Шаги:**
1. В `process_payment()`:
   - Переместить отправку сообщения в `finally` блок
   - Если платеж создан в БД, но нет `pay_url` → отправить сообщение об ошибке
   - Отменить платеж в БД

**Плюсы:**
- ✅ Пользователь всегда получает ответ

**Минусы:**
- ⚠️ Не решает корневую проблему (платеж в БД без YooKassa ID)
- ⚠️ Нужно дополнительно отменять платежи

## Рекомендация
**Использовать Вариант 1** - это правильный подход с точки зрения архитектуры:
- Платеж в БД создается только при успешном создании в платежном шлюзе
- Нет "висящих" записей в БД
- Код становится более логичным

## Дополнительные улучшения
1. **Увеличить таймаут для YooKassa API:**
   - В `yookassa.py` уже есть `Configuration.timeout = 15`
   - Можно увеличить до 30-60 секунд

2. **Добавить retry логику:**
   - При таймауте повторить запрос 1-2 раза
   - Только после всех неудачных попыток выбрасывать исключение

3. **Улучшить логирование:**
   - Логировать все этапы создания платежа
   - Логировать успешную отправку сообщения

4. **Добавить проверку в `_build_payment_keyboard()`:**
   - Если `kb = None` для YooKassa → это ошибка, нужно логировать и выбрасывать исключение

## Файлы для изменения
1. `app/payments/manager.py` - изменить логику для YooKassa
2. `app/payments/gateway/yookassa.py` - создать платеж в БД после успешного ответа API
3. `app/core/handlers/payments.py` - возможно, улучшить обработку ошибок


